---
layout: post
title: Linux & NTFS
date: 2009-12-25 15:39:00.000000000 +08:00
type: post
published: true
status: publish
categories:
- Linux
- Tech Note
tags: []
meta:
  blogger_blog: mingstert.blogspot.com
  blogger_author: mingster
  blogger_ca678228220bc856f5131874f02e04d9_permalink: '5435088457858303059'
  blogger_permalink: "/2009/12/linux-ntfs.html"
  _blogger_self: https://www.blogger.com/feeds/7772966/posts/default/5435088457858303059
  _jetpack_related_posts_cache: a:0:{}
  original_post_id: '235'
  _wp_old_slug: '235'
author: mingster
---
<p>from <a href="http://www.linux-mag.com/id/5523">http://www.linux-mag.com/id/5523</a><br />Several tools exist that support NTFS in Linux:</p>
<ul>
<li><b>Linux kernel driver</b> The Linux kernel has long included an NTFS driver. In the distant past, this driver supported a reliable read-only mode and a rather unreliable write mode. More recent versions (included in 2.5.11 and later kernels) have been extensively overhauled, and now provide reliable read support and reliable– but limited– write support. In particular, many directory options aren't supported.</li>
<li><b>ntfsprogs</b>  This <a class="story_link" href="http://www.linux-ntfs.org/">project</a> uses <a class="story_link" href="http://fuse.sourceforge.net/">FUSE</a> to provide access to NTFS volumes. (For more on FUSE, see <a href="http://www.linux-mag.com/id/2566/">"Lighting the FUSE"</a>)  The <span class="code">ntfsmount</span> program mounts NTFS volumes with more features than the standard kernel driver, but because it's a userspace driver, it's slower. (Many distributions' binary packages omit the <span class="code">ntfsmount</span> utility in favor of the NTFS-3G driver.) Although a 2.0.0 release is available, I've seen claims of unreliability in this version, so you may want to stick with a 1.1.x release (1.1.3 is current as I write) until the 2.x line stabilizes. The package as a whole includes utilities to create, resize, clone, and perform other actions on NTFS volumes. Utilities to directly access an NTFS volume, without mounting it, are also part of the package.</li>
<li><b>NTFS-3G</b>  This package is a FUSE-based NTFS driver. It's a fork of an earlier version of <span class="code">ntfsmount</span>, but it seems to be the favored tool of many distributions. It provides no ancillary utilities; for that, you should install <span class="code">ntfsprogs</span>. The developers claim that its speed is comparable to that of many Linux-native filesystems, despite being a userspace driver. Check <a class="story_link" href="http://www.ntfs-3g.org/">the website</a> for more details.</li>
<li><b>Paragon</b>  <a class="story_link" href="http://www.ntfs-linux.com/">Paragon Software Group</a> has developed a commercial NTFS driver for Linux. This driver provides full read/write support, but it's a binary driver without source code.</li>
<li><b>Captive</b>  This <a class="story_link" href="http://www.jankratochvil.net/project/captive/">project</a> takes an unusual approach to NTFS support: It uses an open source wrapper and the <i>NTFS.DLL</i> driver file from Windows itself to provide NTFS access. This means that the hard work of parsing the NTFS data structures is done by Microsoft's own code. This sounds great, but the implementation (via FUSE) tends to be slow. The project has also been abandoned, so although you might get Captive working, it might stop working one day.</li>
</ul>
<p>That's the overview. The rest of this column describes the NTFS-3G driver and ntfsprogs utilities in more detail. Although the other Linux NTFS tools may be useful in particular situations, these two packages are the most capable and popular ones available today.
<div class="subhead">Using NTFS-3G to Access NTFS Volumes</div>
<p>Most modern Linux distributions ship with NTFS-3G, available in a package called <i>ntfs3g</i> or <i>ntfs-3g</i>. Thus, you should be able to install the NTFS-3G driver by using APT, yum, emerge, or some other package management tool. When you do so, necessary dependencies, such as FUSE, will be installed along with the NTFS-3G driver itself, simplifying the process.<br />If your distribution lacks explicit NTFS-3G support, you can download the source code from the project's Web page. As I write, the latest stable version is 1.1004. The build and installation process is a conventional one: Extract the source code, change to the source code directory, type ./configure to configure the package, type make to build the software, and type <span class="code">make install</span> as <i>root</i> to install the software. Because NTFS-3G relies on FUSE, though, you may need to install it before you can complete your NTFS-3G installation.<br />Once NTFS-3G is installed, accessing your NTFS volumes is a matter of mounting them with a filesystem type code of ntfs-3g:<br /><code>#mount-t ntfs-3g /dev/hda2 /mnt/windows<br /></code><br />This command mounts <i>/dev/hda2</i> at <i>/mnt/windows</i> using the NTFS-3G driver. As just specified, though, the command is rather limited; NTFS-3G defaults to giving ownership of all files to the user who mounted the filesystem, with permissions of 0777 on all files, so every user will be able to read, write, and (theoretically) execute every file. To change permissions and ownership, you must include additional options, similar to those used to achieve the same effects with FAT or most other non-Unix/Linux filesystems:<code><br />#mount-t ntfs-3g-o uid=523,umask=0013 /dev/hda2 /mnt/windows</code><br />This example gives ownership of all files to whoever has user ID 523, with permissions of 0764. You might prefer to use fmask and dmask rather than <span class="code">umask</span>; the former two options set file and directory masks independently, enabling you to give directories execute permissions (as is normal in Linux) while keeping those permissions off of ordinary files (since you probably won't store Linux executables on an NTFS partition).<br />If you want to have your system mount NTFS partitions automatically on startup, or give ordinary users the ability to mount and unmount NTFS volumes, you can add an entry to <i>/etc/fstab</i> for this purpose. This entry will look like any other <i>/etc/fstab</i> entry, except of course for the fact that it will specify a filesystem type of <i>ntfs-3g</i>:<br /><code>/dev/hda2 /mnt/windows ntfs-3g users,uid=523,noauto 0 0</code><br />If ordinary users should be able to mount and umount the partition (as implied by the users option in the preceding line), you may need to make one additional change to your configuration: The NTFS-3G mount helper program (typically installed as <i>/bin/ntfs-3g</i>, <i>/sbin/mount.ntfs-3g</i>, or something similar) must be set SUID <i>root</i>. If this is not done, then only <i>root</i> will be able to mount and unmount NTFS volumes, even if the users or similar options are specified in <i>/etc/fstab</i>. To make this change, use the <span class="code">chmod</span> utility:<br /><code>#chmod a+s /bin/ntfs-3g</code><br />You should set the SUID bit on the file that's installed on your system, of course; it may or may not be called <i>/bin/ntfs-3g</i>. Use your distribution's package manager or simply look for files with <i>ntfs</i> in their names in the <i>/bin</i>, <i>/sbin</i>, and perhaps <i>/usr/bin</i> and <i>/usr/sbin</i> directories, or in the <i>/usr/local</i> equivalents if you installed from source code.<br />With these procedures in place, you should now be able to access files on your NTFS partitions, as well as on removable NTFS media. You should be able to read and write files, create new files, and otherwise treat the filesystem as if it were a FAT filesystem. Note that the NTFS-3G driver doesn't yet support Linux-style ownership and permissions, except insofar as you set them globally in mount options. Thus, you can't really use an NTFS volume as a fully functional substitute for a Linux-native filesystem such as Ext3 or ReiserFS. You can, though, copy files on and off of such filesystems for interchange with another OS on the same computer or use on another computer.
<div class="subhead">Manipulating NTFS Volumes</div>
<p>Although the NTFS-3G driver permits access to your NTFS volumes, you'll need other tools if you need to manipulate these volumes in any way. Such manipulation can be handy if a disk has become corrupt, if you need to resize a volume, or if you need to create a new NTFS volume, to name just three examples.<br />The <span class="code">ntfsprogs</span> package delivers the tools you'll need to help out in such situations. Use your package manager to check the files installed from this package, or review the programs and documentation that are built from a source package, to learn precisely what this package includes. I'll present a brief run-through demonstrating several common NTFS operations.<br />To begin, you should have a test partition. I use <i>/dev/sdb4</i> (a Zip disk on my system) in the following examples. The <span class="code">mkntfs</span> program (often also accessible as <span class="code">mkfs.ntfs</span>) creates an NTFS volume:<br /><code>#mkntfs /dev/sdb4</code><br />This process can take a while; <span class="code">mkntfs</span> is much slower than most other Linux filesystem-creation tools. Consult the man page for <span class="code">mkntfs</span> to learn about its many options. One option you might want to use is -L, which lets you set the volume name. If you want to change the volume name, or if you forget to set it with <span class="code">mkntfs</span>, you can set it with the <span class="code">ntfslabel</span> command:<br /><code>#ntfslabel /dev/sdb4 NTFS_test</code><br />At this point, the filesystem is ready for use, so it can be mounted and accessed as described earlier. Many subsequent NTFS utilities are pointless without files on the filesystem, so I mounted it, copied some files, unmounted the filesystem, mounted it again, deleted one file, and then unmounted the volume:<br /><code># mount -t ntfs-3g /dev/sdb4 /mnt/zip<br /># cp * /mnt/zip<br /># umount /mnt/zip<br /># mount -t ntfs-3g /dev/sdb4 /mnt/zip<br /># rm /mnt/zip/file4.txt<br /># umount /mnt/zip</code><br />A series of programs, <span class="code">ntfsls</span>, <span class="code">ntfscat</span>, and <span class="code">ntfscp</span>, work on <i>unmounted</i> NTFS volumes in ways similar to the standard Linux <span class="code">ls</span>, <span class="code">cat</span>, and <span class="code">cp</span> commands. The <span class="code">ntfscp</span> command is very limited, though; it only enables you to overwrite existing files on an NTFS volume, not copy files off an NTFS volume or copy a file from Linux to a new NTFS file. A few commands demonstrate these utilities:<br /><code># ntfsls /dev/sdb4 file1.txt file2.txt file3.txt<br /># ntfscat /dev/sdb4 file1.txt &gt; file1.txt.bak<br /># ntfscp /dev/sdb4 file1.txt file3.txt</code><br />Note that this example uses <span class="code">ntfscat</span> as a stand-in for an NTFS-to-Linux <span class="code">cp</span> command, by redirecting output to a normal file. You can of course use it to view the contents of a text file instead. The <span class="code">ntfscp</span> command copies the local <i>file1.txt</i> to overwrite file3.txt on the NTFS volume. You can verify that this operation occurred as expected by copying the file back with ntfscat or by mounting the volume using any Linux NTFS driver.<br />Earlier, I copied a file to the NTFS partition and then deleted it. I did this to enable demonstration of the <span class="code">ntfsundelete</span> tool, whose function you can ascertain from its name. This tool is complex, so you should consult its <code>man</code> page for details; however, a basic demonstration can be fairly simple:<br /><code># ntfsundelete --scan /dev/sdb4</p>
<p>Inode  Flags  %age  Date       Size  Filename<br />---------------------------------------------<br />16     F...     0%  2007-10-18     0  <br />17     F…     0%  2007-10-18     0  <br />18     F…     0%  2007-10-18     0  <br />19     F…     0%  2007-10-18     0  <br />20     F…     0%  2007-10-18     0  <br />21     F…     0%  2007-10-18     0  <br />22     F…     0%  2007-10-18     0  <br />23     F…     0%  2007-10-18     0  <br />30     FN..   100%  2007-10-18  1144  <br />Files with potentially recoverable content: 1</p>
<p># ntfsundelete –undelete –inode 30 –output recovered.txt /dev/sdb4<br /></code><br />These commands create a file (<i>recovered.txt</i>) on the local Linux filesystem from the file with inode number 30 identified in the scan operation. You may also be able to specify filenames using the <span class="code">--match pattern</span> option rather than the <span class="code">--inode number</span> option; however, filenames are often lost even when the files still exist. Of course, as with any undelete operation on any filesystem, recovery isn't guaranteed; the space allocated to a file may have been overwritten between the file's deletion and the recovery attempt. Even if a file is created, it could be truncated or include garbage not present in the original file.<br />Another useful maintenance tool is <span class="code">ntfsclone</span>, which lets you create a backup of an NTFS volume. The <span class="code">--save-image</span> (<span class="code">-s</span>) option lets you create an image file backup that omits unused sectors for a space-saving backup, specifying the destination with the <span class="code">--output</span> (<span class="code">-o</span>) option:<br /><code>#ntfsclone-s-o ntfs-backup.img /dev/sdb4</code><br />To restore the backup, you'll use the <span class="code">--restore-image</span> (<span class="code">-r</span>) option, but you must replace the <span class="code">-o</span> option with the <span class="code">--overwrite</span> (<span class="code">-O</span>) option:<br /><code>#ntfsclone-r-O /dev/sdb4 ntfs-backup.img</code><br />Note that you always specify the source filesystem <i>last</i> with <span class="code">ntfsclone</span> and specify the target filesystem with the <span class="code">-o</span> or <span class="code">-O</span> option; you don't list the source and target in order, as you do with <span class="code">cp</span>.<br />A few additional tools, such as <span class="code">ntfsinfo</span>, <span class="code">ntfscmp</span>, and <span class="code">ntfsresize</span>, exist. However, the first two of these are most useful to NTFS developers. <span class="code">ntfsresize</span> is best avoided in favor of <span class="code">parted</span>, QTParted, or some other dedicated partition-resizing tool, since <span class="code">ntfsresize</span> requires separate resizing of the filesystem and the partition that contains it, which can lead to errors if you're not careful.<br />Most of these utilities should only be used on unmounted partitions; using them on partitions that are mounted could cause confusion to whatever Linux NTFS driver you're using, particularly if the utility changes the filesystem in any way. In most cases, you must be <i>root</i> to use these tools, since ordinary users can't act on the Linux device files for partitions.</p>
